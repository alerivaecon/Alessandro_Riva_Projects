############## PROGRAMMING COURSE-PSE-PROJECT-ALESSANDRO RIVA

#### THE FOLLOWING PYTHON SCRIPT HAS THE GOAL OF ITERATIVELY LOOPING OVER A FOLDER AND FETCHING PDF FILES 
#### WHICH I NEED TO DIGITIZE FOR A PROJECT I HAVE IN ECONOMIC HISTORY 

# The code makes heavy use of OCR packages to tranform scanned PDF files into txt files

# First, import the necessary OCR libraries

import os            
import pymupdf as fitz  

# We will use Tesseract, one of the most popular OCR packages, but there are also others out there!
import pytesseract   
from PIL import Image 

# Define the input and outpur folder paths
INPUT_FOLDER = 'YOUR_INPUT_FOLDER'
BASE_OUTPUT_FOLDER = 'YOUR_OUTPUT_FOLDER'

# Automatically create the main output folder if it doesn't already exist
if not os.path.exists(BASE_OUTPUT_FOLDER):
    os.makedirs(BASE_OUTPUT_FOLDER)

# Now, define a command which loops over the PDFs and converts them into txt

def batch_process():
    """
    Loops through the input folder, converts each PDF page to an image,
    runs OCR, and saves the text into organized subfolders.
    """
    
    # 1. Identify all PDF files in the source folder 
    all_files = [f for f in os.listdir(INPUT_FOLDER) if f.lower().endswith('.pdf')]
    print(f"Found {len(all_files)} PDF files to process.")

    for filename in all_files:
        # path to the current PDF file
        pdf_path = os.path.join(INPUT_FOLDER, filename)
        
        # create a subfolder named after the PDF file
      
        subfolder_name = os.path.splitext(filename)[0]
        pdf_output_dir = os.path.join(BASE_OUTPUT_FOLDER, subfolder_name)
        
        # Ensure that the subfolder for the current record exists
        if not os.path.exists(pdf_output_dir):
            os.makedirs(pdf_output_dir)
            
        print(f"\n--- Starting Digitization: {filename} ---")
        
        try:
            # Open the PDF file
            doc = fitz.open(pdf_path)
            
            # Iterate through every page in the current PDF
            for i, page in enumerate(doc):
                # 3. Convert PDF page to a high-quality image
                # We will use a 2x2 matrix to scale the page: 
                # we do this to allow for good enough accuracy while also not using enough RAM to crash the PC
                
                pix = page.get_pixmap(matrix=fitz.Matrix(2, 2))
                
                # Convert the raw pixel data into a format Tesseract can understand
                img = Image.frombytes("RGB", [pix.width, pix.height], pix.samples)
                
                # 4. Perform Optical Character Recognition (OCR)
                # what is --psm 3?: It's a command that tells Tesseract to "Fully automate page segmentation."
                # This is vital for our case because our documents contains
                # multiple columns which have to be read in order to make sense
                
                text = pytesseract.image_to_string(img, config='--psm 3')
                
                # 5. Save the extracted text to a .txt file named after the page number
                output_file = os.path.join(pdf_output_dir, f"Page_{i+1}.txt")
                with open(output_file, "w", encoding="utf-8") as f:
                    f.write(text)
                
                print(f"  > Page {i+1} saved to folder: {subfolder_name}")
            
            # Close the document to free up system memory: it's an important step to not clog the memory, which is scarce!
            doc.close()
            print(f"✅ Successfully finished: {filename}")

        except Exception as e:
            # If a specific file is corrupted or there are problems, print the error and move to the next file
            print(f"❌ Error processing {filename}: {e}")

# Print success at the end to notice when the program is finished
if __name__ == "__main__":
    batch_process()
    print(f"\n ALL FILES DIGITIZED!")
    print(f"results availablehere: {BASE_OUTPUT_FOLDER}")
